name: Docker

on:
  schedule:
    - cron: "17 15 * * *"
  push:
    branches: ["master"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    if: github.event_name == 'release' && github.event.action == 'published' && github.server_url != 'https://github.com'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      SERVER_URL: ${{ github.server_url }}
      REPOSITORY: ${{ github.repository }}
      REF_NAME: ${{ github.ref_name }}
      REF_TYPE: ${{ github.ref_type }}
      EVENT_NAME: ${{ github.event_name }}
      SHA: ${{ github.sha }}
      ACTOR: ${{ github.actor }}
      REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
      REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Derive image coordinates
        id: image
        shell: bash
        run: |
          set -eu
          if [ "$SERVER_URL" = "https://github.com" ]; then
            registry="ghcr.io"
          else
            registry="${{ vars.INTERNAL_DOCKER_REGISTRY }}"
            registry="${registry#https://}"
            registry="${registry#http://}"
          fi

          echo "registry=$registry" >> "$GITHUB_OUTPUT"
          echo "image=$registry/$REPOSITORY" >> "$GITHUB_OUTPUT"

      - name: Build image
        shell: bash
        run: |
          set -eu
          image="${{ steps.image.outputs.image }}"
          short_sha="$(printf '%.12s' "$SHA")"

          tag_args="-t ${image}:sha-${short_sha}"
          if [ "$REF_TYPE" = "tag" ]; then
            tag_args="$tag_args -t ${image}:${REF_NAME}"
          fi
          if [ "$REF_TYPE" = "branch" ] && [ "$REF_NAME" = "master" ]; then
            tag_args="$tag_args -t ${image}:latest"
          fi

          docker build $tag_args .

      - name: Login to internal Forgejo registry
        run: |
          echo "${{ secrets.PACKAGE_TOKEN }}" \
            | docker login "${{ vars.INTERNAL_DOCKER_REGISTRY }}" \
              -u "${{ vars.INTERNAL_DOCKER_USERNAME }}" \
              --password-stdin

      - name: Push image
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          set -eu
          image="${{ steps.image.outputs.image }}"
          short_sha="$(printf '%.12s' "$SHA")"

          docker push "${image}:sha-${short_sha}"
          if [ "$REF_TYPE" = "tag" ]; then
            docker push "${image}:${REF_NAME}"
          fi
          if [ "$REF_TYPE" = "branch" ] && [ "$REF_NAME" = "master" ]; then
            docker push "${image}:latest"
          fi
